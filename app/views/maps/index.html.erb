<p id="notice"><%= notice %></p>

<h1>Maps</h1>

<table>
  <thead>
    <tr>
      <th>Lat</th>
      <th>Lng</th>
      <th>Text</th>
      <th colspan="3"></th>
    </tr>
  </thead>

  <tbody>
    <% @maps.each do |map| %>
      <tr>
        <td><%= map.lat %></td>
        <td><%= map.lng %></td>
        <td><%= map.text %></td>
        <td><%= link_to 'Show', map %></td>
        <td><%= link_to 'Edit', edit_map_path(map) %></td>
        <td><%= link_to 'Destroy', map, method: :delete, data: { confirm: 'Are you sure?' } %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<br>

<%= link_to 'New Map', new_map_path %>

<!-- app/views/maps/show.html.erb -->
<%= render 'form', map: @map %>

<div id="map" class="show-map"></div>
<div id="modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background-color:white; padding:20px; box-shadow:0 0 10px rgba(0,0,0,0.5);">
    ここを編集する
    <button onclick="closeModal()">Close</button>
</div>

<script>
  var map;
  var geocoder; // Geocoder

  function initMap() {
    var center = {
      lat: 35.6895,
      lng: 139.6917
    }; // 東京の緯度経度
    map = new google.maps.Map(document.getElementById('map'), {
      center: center,
      zoom: 10
    });
    geocoder = new google.maps.Geocoder(); // Geocoder初期化
    google.maps.event.addListener(map, 'click', function(event) {
      placeMarker(event.latLng);
    });
  }

  function placeMarker(location) {
    var marker = new google.maps.Marker({
      position: location,
      map: map
    });

    geocoder.geocode({"location": location}, function(results, status) {
      if (status === "OK" && results[0]) {
        var address = results[0].formatted_address;
        var infoWindow = new google.maps.InfoWindow({
          content: `
          <div class="custom-info">
            <div class="custom-info-item name">${address}</div>
          </div>
          <button id="popupbutton">open!</button>
          `
        });
        marker.addListener('click', function() {
          infoWindow.open(map, marker);

          // Add the event listener after the InfoWindow is opened
          google.maps.event.addListenerOnce(infoWindow, 'domready', function(){
            document.getElementById('popupbutton').addEventListener('click', openModal);
          });
        });
      } else {
        alert("Geocode was not successful for the following reason:" + status);
      }
    });

    // 緯度経度をhidden_fieldにセット
    document.getElementById('map_lat').value = location.lat();
    document.getElementById('map_lng').value = location.lng();
  }

  function openModal() {
    document.getElementById('modal').style.display = 'block';
  }

  function closeModal() {
    document.getElementById('modal').style.display = 'none';
  }
</script>

<!-- ピン編集フォーム -->
<!--<div id="edit-pin-form" style="display: none;">-->
<!--  <%#= link_to "show", edit_map_path%>-->
<!--</div>-->

<!-- ピン削除ボタン -->
<!--<button id="delete-pin-button">削除</button>-->

<!-- ここでGoogle Maps JavaScript APIを読み込み -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB7JXfKdyGbC5w6U1mZljK1ii619BA3mr0&libraries=places&callback=initMap" async defer></script>
